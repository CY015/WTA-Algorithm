import numpy as np
import random
import time
from typing import List, Tuple, Dict


class Target:
    def __init__(self, target_id: int, value: float, components: List[Tuple[float, float]]):
        self.id = target_id
        self.value = value
        self.components = components  # (权重, 健康度)列表

        # 1. 提取所有部件的初始重要度权重
        original_importances = [comp[0] for comp in components]
        
        # # 2. 验证初始重要度权重取值合法性（符合建模的0.2/0.5/0.8要求）
        # for imp in original_importances:
        #     if imp not in (0.2, 0.5, 0.8):
        #         raise ValueError(
        #             f"部件初始重要度权重{imp}不合法！仅支持Word文档建模定义的0.2（不重要）、0.5（中等）、0.8（重要）三种取值"
        #         )
        
        # 3. 计算初始重要度权重总和，避免除零错误
        total_original_importance = sum(original_importances)
        if total_original_importance == 0:
            raise ValueError("目标所有部件的初始重要度权重之和不能为0！请至少为一个部件分配有效权重")
        
        # 4. 执行归一化计算：单个部件最终重要度 = 该部件初始权重 / 所有部件初始权重之和（贴合Word文档公式）
        self.normalized_importances = [imp / total_original_importance for imp in original_importances]

    def calculate_damage_effect(self, ammo_damage_prob: List[float]) -> float:
        """计算弹药对该目标的毁伤效能（使用归一化后的重要度权重）"""
        total_effect = 0.0
        # 校验：毁伤概率列表长度需与部件数量一致
        if len(ammo_damage_prob) != len(self.components):
            raise ValueError(f"弹药毁伤概率列表长度（{len(ammo_damage_prob)}）与目标部件数量（{len(self.components)}）不匹配！")
        
        # 核心计算：使用归一化后的重要度权重（替换原始权重），健康度参数仍保留（虽未使用，不破坏原有格式）
        for (_, health), norm_importance, damage_prob in zip(self.components, self.normalized_importances, ammo_damage_prob):
            # 保留health参数位置，如需后续启用动态健康度逻辑，可直接取消注释下方代码
            # total_effect += norm_importance * damage_prob * health
            total_effect += norm_importance * damage_prob
        return total_effect


class Ammunition:
    def __init__(self, ammo_id: int, cost: float, stock: int, damage_profiles: Dict[int, List[float]]):
        self.id = ammo_id
        self.cost = cost
        self.stock = stock
        self.damage_profiles = damage_profiles


class MOEA_D_Solver:
    def __init__(self, targets: List[Target], ammunitions: List[Ammunition],
                 adaptability_matrix: np.ndarray, damage_threshold: float):
        self.targets = targets
        self.ammunitions = ammunitions
        self.adaptability_matrix = adaptability_matrix
        self.damage_threshold = damage_threshold

        # 与NSGA-II保持一致的核心参数
        self.pop_size = 30
        self.max_generations = 500
        self.crossover_rate_max = 0.8  # 最大交叉概率
        # self.crossover_rate_min = 0.7  # 最小交叉概率
        self.mutation_rate_max = 0.2  # 最大变异概率
        # self.mutation_rate_min = 0.1  # 最小变异概率

        # MOEA/D特有参数
        self.T = 5  # 邻居规模
        self.weights = self.generate_weights()
        self.neighbors = self.generate_neighbors()
        self.ideal_point = None  # 理想点

    def generate_weights(self) -> np.ndarray:
        weights = []
        for i in range(self.pop_size):
            w1 = i / (self.pop_size - 1) if self.pop_size > 1 else 0.5
            w2 = 1 - w1
            weights.append([w1, w2])
        return np.array(weights)

    def generate_neighbors(self) -> List[List[int]]:
        neighbors = []
        for i in range(self.pop_size):
            distances = [np.linalg.norm(self.weights[i] - self.weights[j]) for j in range(self.pop_size)]
            sorted_indices = np.argsort(distances)
            neighbors.append([sorted_indices[j] for j in range(1, self.T + 1)])
        return neighbors

    def calculate_actual_damage(self, chromosome: np.ndarray, target_id: int) -> float:
        survival_prob = 1.0
        for i in range(len(self.ammunitions)):
            if chromosome[i, target_id] > 0:
                e_ij = self.adaptability_matrix[i, target_id] * self.targets[target_id].calculate_damage_effect(
                    self.ammunitions[i].damage_profiles.get(self.targets[target_id].id,
                                                            [0.1] * len(self.targets[target_id].components))
                )
                survival_prob *= (1 - e_ij) ** chromosome[i, target_id]
        return 1 - survival_prob

    def evaluate_objectives_with_penalty(self, chromosome: np.ndarray) -> Tuple[float, float, float]:
        """带惩罚项的目标函数评估（与NSGA-II保持一致）"""
        total_effect = 0.0
        total_cost = 0.0
        penalty = 0.0

        # 计算弹药库存惩罚
        for i in range(len(self.ammunitions)):
            total_used = np.sum(chromosome[i, :])
            if total_used > self.ammunitions[i].stock:
                penalty += (total_used - self.ammunitions[i].stock) * 100  # 库存超限惩罚

        # 计算毁伤和成本
        for j in range(len(self.targets)):
            target_damage = self.calculate_actual_damage(chromosome, j)
            total_effect += self.targets[j].value * target_damage
            if target_damage < self.damage_threshold:
                penalty += (self.damage_threshold - target_damage) * 1000  # 毁伤不足惩罚

            for i in range(len(self.ammunitions)):
                total_cost += self.ammunitions[i].cost * chromosome[i, j]

        total_time = np.sum(chromosome) * 0.5
        ce = total_effect / total_cost if total_cost > 0 else 0.001

        # 应用惩罚（转为最小化问题）
        return 1 / ce + penalty, total_time + penalty, penalty

    def evaluate_objectives(self, chromosome: np.ndarray) -> Tuple[float, float]:
        """基础目标函数评估"""
        ce, time_cost, _ = self.evaluate_objectives_with_penalty(chromosome)
        return ce, time_cost

    def initialize_population(self) -> List[np.ndarray]:
        """与NSGA-II一致的初始化逻辑"""
        population = []
        target_count = len(self.targets)
        ammo_count = len(self.ammunitions)

        for _ in range(self.pop_size):
            chromosome = np.zeros((ammo_count, target_count), dtype=int)
            # 基础随机初始化
            for j in range(target_count):
                for i in range(ammo_count):
                    if random.random() < 0.3:
                        max_possible = self.ammunitions[i].stock // target_count
                        if max_possible > 0:
                            chromosome[i, j] = random.randint(1, max_possible)
            # 简单修复（确保基本毁伤）
            for j in range(target_count):
                if self.calculate_actual_damage(chromosome, j) < self.damage_threshold * 0.7:
                    best_ammo = np.argmax([self.adaptability_matrix[i, j] for i in range(ammo_count)])
                    chromosome[best_ammo, j] += 1
            population.append(chromosome)
        return population

    def update_ideal_point(self, objectives: List[Tuple[float, float]]) -> None:
        """更新理想点"""
        if self.ideal_point is None:
            self.ideal_point = np.array([min(f1 for f1, f2 in objectives),
                                         min(f2 for f1, f2 in objectives)])
        else:
            self.ideal_point[0] = min(self.ideal_point[0], min(f1 for f1, f2 in objectives))
            self.ideal_point[1] = min(self.ideal_point[1], min(f2 for f1, f2 in objectives))

    def tchebycheff(self, obj: Tuple[float, float], weight_idx: int) -> float:
        """Tchebycheff分解函数"""
        w = self.weights[weight_idx]
        f1, f2 = obj
        return max(w[0] * abs(f1 - self.ideal_point[0]),
                   w[1] * abs(f2 - self.ideal_point[1]))

    def crossover_mutation(self, parent1: np.ndarray, parent2: np.ndarray, generation: int) -> np.ndarray:
        """基础交叉变异（无自适应策略）"""
        # 固定概率交叉
        if random.random() < self.crossover_rate_max:
            crossover_point = random.randint(1, parent1.shape[1] - 1)
            child = np.hstack([parent1[:, :crossover_point], parent2[:, crossover_point:]])
        else:
            child = parent1.copy()

        # 固定概率变异
        if random.random() < self.mutation_rate_max:
            i = random.randint(0, child.shape[0] - 1)
            j = random.randint(0, child.shape[1] - 1)
            child[i, j] = max(0, child[i, j] + random.choice([-1, 1]))

            # 简单库存检查
            if np.sum(child[i, :]) > self.ammunitions[i].stock:
                child[i, j] = max(0, child[i, j] - random.choice([1, 2]))

        return child

    def repair_solution(self, chromosome: np.ndarray) -> np.ndarray:
        """与NSGA-II一致的修复逻辑"""
        repaired = chromosome.copy()
        for j in range(len(self.targets)):
            while self.calculate_actual_damage(repaired, j) < self.damage_threshold:
                best_ammo = np.argmax([self.adaptability_matrix[i, j] for i in range(len(self.ammunitions))])
                if np.sum(repaired[best_ammo, :]) < self.ammunitions[best_ammo].stock:
                    repaired[best_ammo, j] += 1
                else:
                    break
        return repaired

    def solutions_are_similar(self, sol1: np.ndarray, sol2: np.ndarray, tolerance: float = 0.01) -> bool:
        """与NSGA-II一致的解相似性判断"""
        obj1 = self.evaluate_objectives_with_penalty(sol1)[:2]
        obj2 = self.evaluate_objectives_with_penalty(sol2)[:2]

        ce_similar = abs(obj1[0] - obj2[0]) / max(abs(obj1[0]), abs(obj2[0]), 1e-10) < tolerance
        time_similar = abs(obj1[1] - obj2[1]) / max(abs(obj1[1]), abs(obj2[1]), 1e-10) < tolerance

        return ce_similar and time_similar

    def solve(self) -> Tuple[List[Tuple[np.ndarray, Tuple[float, float], int, float]], int]:
        """主求解流程"""
        self.pop = self.initialize_population()
        self.fitness = [self.evaluate_objectives(ind) for ind in self.pop]
        self.update_ideal_point(self.fitness)
        convergence_gen = self.max_generations
        non_dominated_solutions = []
        gen_best_ce = []

        start_time = time.time()

        for gen in range(self.max_generations):
            # 对每个子问题进行优化
            for i in range(self.pop_size):
                # 从邻居中选择2个父代
                parents = random.sample(self.neighbors[i], 2)
                p1, p2 = self.pop[parents[0]], self.pop[parents[1]]

                # 生成子代并修复
                child = self.crossover_mutation(p1, p2, gen)
                child = self.repair_solution(child)
                child_obj = self.evaluate_objectives(child)

                # 更新理想点
                self.update_ideal_point([child_obj])

                # 用子代更新邻居中的劣解
                for j in self.neighbors[i]:
                    if self.tchebycheff(child_obj, j) < self.tchebycheff(self.fitness[j], j):
                        self.pop[j] = child.copy()
                        self.fitness[j] = child_obj

            # 收集非支配解
            current_pop_with_obj = list(zip(self.pop, self.fitness))
            current_non_dominated = []
            for ind, obj in current_pop_with_obj:
                ce = 1 / obj[0] if obj[0] != 0 else 0
                time_cost = obj[1]
                dominated = False
                for other_ind, other_obj in current_pop_with_obj:
                    other_ce = 1 / other_obj[0] if other_obj[0] != 0 else 0
                    other_time = other_obj[1]
                    if other_ce >= ce and other_time <= time_cost and (other_ce > ce or other_time < time_cost):
                        dominated = True
                        break
                if not dominated:
                    current_non_dominated.append((ind, (ce, time_cost), gen, time.time() - start_time))

            # 去重并更新全局非支配解
            for sol in current_non_dominated:
                is_duplicate = False
                for existing in non_dominated_solutions:
                    if self.solutions_are_similar(sol[0], existing[0]):
                        is_duplicate = True
                        break
                if not is_duplicate:
                    non_dominated_solutions.append(sol)

            # 记录每代最优费效比
            current_best = max([1 / obj[0] for obj in self.fitness])
            gen_best_ce.append(current_best)

            # 收敛判断（连续20代无改进）
            if gen > 20:
                recent_best = max(gen_best_ce[-20:])
                if abs(recent_best - gen_best_ce[-1]) < 1e-6:
                    convergence_gen = gen
                    break

            if gen % 20 == 0:
                print(f"MOEA/D Generation {gen}: Best CE = {current_best:.4f}")

        # 最终去重
        unique_solutions = []
        for sol in non_dominated_solutions:
            is_unique = True
            for existing in unique_solutions:
                if self.solutions_are_similar(sol[0], existing[0]):
                    is_unique = False
                    break
            if is_unique:
                unique_solutions.append(sol)

        return unique_solutions, convergence_gen


def run_multiple_tests(test_times: int = 15):
    """多次独立测试函数"""
    stats = {
        "best_ce_list": [],
        "avg_ce_list": [],
        "best_task_time": [],      # 新增：每次测试中最优（最小）任务时间
        "avg_task_time": [],       # 新增：每次测试中Pareto解的平均任务时间
        "feasible_ratio_list": [],
        "convergence_gen_list": [],
        "total_time_list": [],
        "unique_solutions_num_list": []
    }

    # 全局最优解跟踪
    global_best_ce = -float('inf')
    global_best_solution = None
    global_best_metadata = None

# 测试参数(8*5个目标)
    targets = [
        Target(1, 80.0, [(0.5, 1.0)]),# 人员集群
        Target(2, 120.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0)]),# 地下指挥所
        Target(3, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0)]),# 陆基雷达站
        Target(4, 110.0, [(0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.2, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.2, 1.0), (0.8, 1.0), 
                          (0.5, 1.0)]),# 机场
        Target(5, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
    ]

    ammunitions = [
        Ammunition(1, 13.0, 10, {
            1: [0.8], 
            2: [0.8, 0.8, 0.8, 0.6, 0.6,
                0.5, 0.8, 0.7, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.8, 0.1], 
            3: [0.5, 0.2, 0.6, 0.7, 0.8,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            4: [0.2, 0.2, 0.8, 0.7, 0.7,
                0.7, 0.7, 0.2, 0.2, 0.3,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.6], 
            5: [0.7, 0.7, 0.7, 0.8, 0.8,
                0.8, 0.8, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.8, 0.7, 0.7, 0.6, 0.6,
                0.7, 0.5, 0.7, 0.7, 0.7,
                0.5, 0.6, 0.5, 
                0.5, 0.7, 0.5, 0.5, 0.5, 
                0.5, 0.3, 0.7, 0.5, 0.4,
                0.4, 0.4, 0.5, 0.5, 0.5,
                0.5, 0.5, 0.5,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
        }),# 杀爆1(当量大)
        Ammunition(2, 10.0, 10, {
            1: [0.7], 
            2: [0.7, 0.7, 0.7, 0.5, 0.5,
                0.4, 0.7, 0.6, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.7, 0.1], 
            3: [0.4, 0.2, 0.5, 0.6, 0.7,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            4: [0.2, 0.2, 0.7, 0.6, 0.6,
                0.6, 0.6, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.5], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.3, 0.4, 0.3, 0.4, 0.4, 
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.4, 0.4], 
        }),# 杀爆2(当量小)
        Ammunition(3, 20.0, 10, {
            1: [0.1], 
            2: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7, 
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.5, 0.7], 
            3: [0.7, 0.7, 0.3, 0.3, 0.5,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7],
            4: [0.7, 0.7, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.6, 
                0.7], 
            5: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
        }),# 侵爆1(1.8m)
        Ammunition(4, 25.0, 10, {
            1: [0.1], 
            2: [0.65, 0.65, 0.65, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75, 
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.55, 0.75], 
            3: [0.75, 0.75, 0.35, 0.35, 0.55,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75],
            4: [0.75, 0.75, 0.45, 0.45, 0.45,
                0.45, 0.45, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.65, 
                0.75], 
            5: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
        }),# 侵爆2(6m)
        Ammunition(5, 40.0, 10, {
            1: [0.2], 
            2: [0.7, 0.7, 0.7, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8, 
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.6, 0.8], 
            3: [0.8, 0.8, 0.4, 0.4, 0.6,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8],
            4: [0.8, 0.8, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.7, 
                0.8], 
            5: [0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15,                            
                0.15, 0.15, 0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15], 
        }),# 侵爆3(61m)
        Ammunition(6, 27.0, 10, {
            1: [0.9], 
            2: [0.85, 0.85, 0.85, 0.65, 0.65,
                0.55, 0.85, 0.75, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.85, 0.2], 
            3: [0.55, 0.25, 0.65, 0.75, 0.85,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25],
            4: [0.3, 0.3, 0.8, 0.75, 0.7,
                0.7, 0.75, 0.3, 0.3, 0.35,
                0.3, 0.3, 0.3, 0.3, 0.3, 
                0.6], 
            5: [0.75, 0.75, 0.75, 0.85, 0.85,
                0.85, 0.85, 0.65, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.85, 0.75, 0.75, 0.65, 0.65,
                0.75, 0.55, 0.75, 0.75, 0.75,
                0.55, 0.65, 0.55, 
                0.55, 0.75, 0.55, 0.55, 0.55, 
                0.55, 0.35, 0.75, 0.55, 0.45,
                0.45, 0.45, 0.55, 0.55, 0.55,
                0.55, 0.55, 0.55,                           
                0.45, 0.55, 0.45, 0.55, 0.55, 
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.55, 0.55], 
        }),# 子母1
        Ammunition(7, 20.0, 10, {
            1: [0.1], 
            2: [0.6, 0.6, 0.6, 0.6, 0.6,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            3: [0.1, 0.1, 0.1, 0.3, 0.3,
                0.4, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            4: [0.1, 0.1, 0.4, 0.2, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
        }),# 聚能1(1.3m破甲)
        Ammunition(8, 18.0, 10, {
            1: [0.1], 
            2: [0.5, 0.5, 0.5, 0.5, 0.5,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            3: [0.1, 0.1, 0.1, 0.2, 0.2,
                0.3, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            4: [0.1, 0.1, 0.3, 0.15, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
        })# 聚能2(1.1m破甲)
    ]

    adaptability_matrix = np.array([
        [0.9, 0.25, 0.45, 0.25, 0.8],   # 杀爆1
        [0.8, 0.2, 0.4, 0.2, 0.7],      # 杀爆2
        [0.1, 0.7, 0.75, 0.75, 0.1],    # 侵爆1
        [0.1, 0.8, 0.8, 0.8, 0.1],      # 侵爆2
        [0.1, 0.9, 0.85, 0.85, 0.1],    # 侵爆3
        [0.9, 0.3, 0.5, 0.6, 0.9],      # 子母1
        [0.1, 0.2, 0.1, 0.1, 0.7],      # 聚能1
        [0.1, 0.15, 0.1, 0.1, 0.7],     # 聚能2
    ])



    # 测试参数(8*9)
    # targets = [
    #     Target(1, 80.0, [(0.5, 1.0)]),# 人员集群
    #     Target(2, 120.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0)]),# 地下指挥所
    #     Target(3, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0)]),# 陆基雷达站
    #     Target(4, 110.0, [(0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.2, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.2, 1.0), (0.8, 1.0), 
    #                       (0.5, 1.0)]),# 机场
    #     Target(5, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
    #     Target(6, 80.0, [(0.5, 1.0)]),# 人员集群
    #     Target(7, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0)]),# 陆基雷达站
    #     Target(8, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0)]),# 陆基雷达站
    #     Target(9, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
    # ]

    # ammunitions = [
    #     Ammunition(1, 13.0, 10, {
    #         1: [0.8], 
    #         2: [0.8, 0.8, 0.8, 0.6, 0.6,
    #             0.5, 0.8, 0.7, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.8, 0.1], 
    #         3: [0.5, 0.2, 0.6, 0.7, 0.8,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         4: [0.2, 0.2, 0.8, 0.7, 0.7,
    #             0.7, 0.7, 0.2, 0.2, 0.3,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.6], 
    #         5: [0.7, 0.7, 0.7, 0.8, 0.8,
    #             0.8, 0.8, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.8, 0.7, 0.7, 0.6, 0.6,
    #             0.7, 0.5, 0.7, 0.7, 0.7,
    #             0.5, 0.6, 0.5, 
    #             0.5, 0.7, 0.5, 0.5, 0.5, 
    #             0.5, 0.3, 0.7, 0.5, 0.4,
    #             0.4, 0.4, 0.5, 0.5, 0.5,
    #             0.5, 0.5, 0.5,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #         6: [0.8], 
    #         7: [0.5, 0.2, 0.6, 0.7, 0.8,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         8: [0.5, 0.2, 0.6, 0.7, 0.8,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         9: [0.7, 0.7, 0.7, 0.8, 0.8,
    #             0.8, 0.8, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.8, 0.7, 0.7, 0.6, 0.6,
    #             0.7, 0.5, 0.7, 0.7, 0.7,
    #             0.5, 0.6, 0.5, 
    #             0.5, 0.7, 0.5, 0.5, 0.5, 
    #             0.5, 0.3, 0.7, 0.5, 0.4,
    #             0.4, 0.4, 0.5, 0.5, 0.5,
    #             0.5, 0.5, 0.5,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #     }),# 杀爆1(当量大)
    #     Ammunition(2, 10.0, 10, {
    #         1: [0.7], 
    #         2: [0.7, 0.7, 0.7, 0.5, 0.5,
    #             0.4, 0.7, 0.6, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.7, 0.1], 
    #         3: [0.4, 0.2, 0.5, 0.6, 0.7,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         4: [0.2, 0.2, 0.7, 0.6, 0.6,
    #             0.6, 0.6, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.5], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.3, 0.4, 0.3, 0.4, 0.4, 
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.4, 0.4], 
    #         6: [0.7], 
    #         7: [0.4, 0.2, 0.5, 0.6, 0.7,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         8: [0.4, 0.2, 0.5, 0.6, 0.7,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         9: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.3, 0.4, 0.3, 0.4, 0.4, 
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.4, 0.4], 
    #     }),# 杀爆2(当量小)
    #     Ammunition(3, 20.0, 10, {
    #         1: [0.1], 
    #         2: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7, 
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.5, 0.7], 
    #         3: [0.7, 0.7, 0.3, 0.3, 0.5,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7],
    #         4: [0.7, 0.7, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.6, 
    #             0.7], 
    #         5: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         6: [0.1], 
    #         7: [0.7, 0.7, 0.3, 0.3, 0.5,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7],
    #         8: [0.7, 0.7, 0.3, 0.3, 0.5,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7],
    #         9: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #     }),# 侵爆1(1.8m)
    #     Ammunition(4, 25.0, 10, {
    #         1: [0.1], 
    #         2: [0.65, 0.65, 0.65, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75, 
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.55, 0.75], 
    #         3: [0.75, 0.75, 0.35, 0.35, 0.55,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75],
    #         4: [0.75, 0.75, 0.45, 0.45, 0.45,
    #             0.45, 0.45, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.65, 
    #             0.75], 
    #         5: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         6: [0.1], 
    #         7: [0.75, 0.75, 0.35, 0.35, 0.55,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75],
    #         8: [0.75, 0.75, 0.35, 0.35, 0.55,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75],
    #         9: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1],    
    #     }),# 侵爆2(6m)
    #     Ammunition(5, 40.0, 10, {
    #         1: [0.2], 
    #         2: [0.7, 0.7, 0.7, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8, 
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.6, 0.8], 
    #         3: [0.8, 0.8, 0.4, 0.4, 0.6,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8],
    #         4: [0.8, 0.8, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.7, 
    #             0.8], 
    #         5: [0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15,                            
    #             0.15, 0.15, 0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15], 
    #         6: [0.2],
    #         7: [0.8, 0.8, 0.4, 0.4, 0.6,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8],
    #         8: [0.8, 0.8, 0.4, 0.4, 0.6,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8],
    #         9: [0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15,                            
    #             0.15, 0.15, 0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15],
    #     }),# 侵爆3(61m)
    #     Ammunition(6, 27.0, 10, {
    #         1: [0.9], 
    #         2: [0.85, 0.85, 0.85, 0.65, 0.65,
    #             0.55, 0.85, 0.75, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.85, 0.2], 
    #         3: [0.55, 0.25, 0.65, 0.75, 0.85,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25],
    #         4: [0.3, 0.3, 0.8, 0.75, 0.7,
    #             0.7, 0.75, 0.3, 0.3, 0.35,
    #             0.3, 0.3, 0.3, 0.3, 0.3, 
    #             0.6], 
    #         5: [0.75, 0.75, 0.75, 0.85, 0.85,
    #             0.85, 0.85, 0.65, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.85, 0.75, 0.75, 0.65, 0.65,
    #             0.75, 0.55, 0.75, 0.75, 0.75,
    #             0.55, 0.65, 0.55, 
    #             0.55, 0.75, 0.55, 0.55, 0.55, 
    #             0.55, 0.35, 0.75, 0.55, 0.45,
    #             0.45, 0.45, 0.55, 0.55, 0.55,
    #             0.55, 0.55, 0.55,                           
    #             0.45, 0.55, 0.45, 0.55, 0.55, 
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.55, 0.55], 
    #         6: [0.9],
    #         7: [0.55, 0.25, 0.65, 0.75, 0.85,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25],
    #         8: [0.55, 0.25, 0.65, 0.75, 0.85,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25],
    #         9: [0.75, 0.75, 0.75, 0.85, 0.85,
    #             0.85, 0.85, 0.65, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.85, 0.75, 0.75, 0.65, 0.65,
    #             0.75, 0.55, 0.75, 0.75, 0.75,
    #             0.55, 0.65, 0.55, 
    #             0.55, 0.75, 0.55, 0.55, 0.55, 
    #             0.55, 0.35, 0.75, 0.55, 0.45,
    #             0.45, 0.45, 0.55, 0.55, 0.55,
    #             0.55, 0.55, 0.55,                           
    #             0.45, 0.55, 0.45, 0.55, 0.55, 
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.55, 0.55],
    #     }),# 子母1
    #     Ammunition(7, 20.0, 10, {
    #         1: [0.1], 
    #         2: [0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         3: [0.1, 0.1, 0.1, 0.3, 0.3,
    #             0.4, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         4: [0.1, 0.1, 0.4, 0.2, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #         6: [0.1],
    #         7: [0.1, 0.1, 0.1, 0.3, 0.3,
    #             0.4, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         8: [0.1, 0.1, 0.1, 0.3, 0.3,
    #             0.4, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         9: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5],
    #     }),# 聚能1(1.3m破甲)
    #     Ammunition(8, 18.0, 10, {
    #         1: [0.1], 
    #         2: [0.5, 0.5, 0.5, 0.5, 0.5,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         3: [0.1, 0.1, 0.1, 0.2, 0.2,
    #             0.3, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         4: [0.1, 0.1, 0.3, 0.15, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #         6: [0.1],
    #         7: [0.1, 0.1, 0.1, 0.2, 0.2,
    #             0.3, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         8: [0.1, 0.1, 0.1, 0.2, 0.2,
    #             0.3, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         9: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5],
    #     })# 聚能2(1.1m破甲)
    # ]

    # adaptability_matrix = np.array([
    #     [0.9, 0.25, 0.45, 0.25, 0.8, 0.9, 0.45, 0.45, 0.8],   # 杀爆1
    #     [0.8, 0.2, 0.4, 0.2, 0.7, 0.8, 0.4, 0.4, 0.7],      # 杀爆2
    #     [0.1, 0.7, 0.75, 0.75, 0.1, 0.1, 0.75, 0.75, 0.1],    # 侵爆1
    #     [0.1, 0.8, 0.8, 0.8, 0.1, 0.1, 0.8, 0.8, 0.1],      # 侵爆2
    #     [0.1, 0.9, 0.85, 0.85, 0.1, 0.1, 0.85, 0.85, 0.1],    # 侵爆3
    #     [0.9, 0.3, 0.5, 0.6, 0.9, 0.9, 0.5, 0.5, 0.9],      # 子母1
    #     [0.1, 0.2, 0.1, 0.1, 0.7, 0.1, 0.1, 0.1, 0.7],      # 聚能1
    #     [0.1, 0.15, 0.1, 0.1, 0.7, 0.1, 0.1, 0.1, 0.7],     # 聚能2
    # ])
    
    print(f"开始 {test_times} 次独立测试（MOEA/D）...")
    for test_idx in range(test_times):
        print(f"\n=== 第 {test_idx + 1}/{test_times} 次测试 ===")
        random.seed(test_idx)
        np.random.seed(test_idx)

        solver = MOEA_D_Solver(targets, ammunitions, adaptability_matrix, 0.8)
        start_time = time.time()
        pareto_solutions, convergence_gen = solver.solve()
        total_time = time.time() - start_time

        if not pareto_solutions:
            print("本次测试无有效解，跳过")
            continue

        # 统计当前测试结果
        current_ces = [obj[0] for sol, obj, _, _ in pareto_solutions]
        current_best_ce = max(current_ces)
        avg_ce = np.mean(current_ces)
        unique_num = len(pareto_solutions)
        # 新增：统计任务时间（目标2：最小化时间）
        current_task_times = [obj[1] for sol, obj, _, _ in pareto_solutions]
        current_best_task_time = min(current_task_times)      # 任务时间越小越好
        current_avg_task_time = np.mean(current_task_times)

        # 更新统计容器
        stats["best_task_time"].append(current_best_task_time)
        stats["avg_task_time"].append(current_avg_task_time)
        stats["best_ce_list"].append(current_best_ce)
        stats["avg_ce_list"].append(avg_ce)
        stats["feasible_ratio_list"].append(1.0)
        stats["convergence_gen_list"].append(convergence_gen)
        stats["total_time_list"].append(total_time)
        stats["unique_solutions_num_list"].append(unique_num)

        # 更新全局最优
        current_best_idx = np.argmax(current_ces)
        current_best_sol, current_best_obj, current_gen, current_timestamp = pareto_solutions[current_best_idx]

        if current_best_obj[0] > global_best_ce:
            global_best_ce = current_best_obj[0]
            global_best_solution = current_best_sol
            global_best_metadata = (current_best_obj, current_gen, test_idx, current_timestamp)
            print(f"第 {test_idx + 1} 次测试刷新全局最优费效比: {global_best_ce:.3f}")
        else:
            print(f"本次测试最优费效比: {current_best_obj[0]:.4f}（未超过全局最优）")

        # 输出当前测试统计
        print(f"第 {test_idx + 1} 次测试统计：")
        print(f"  最优费效比: {current_best_ce:.3f}, 平均费效比: {avg_ce:.3f}")
        print(f"  收敛代数: {convergence_gen}, 总时间: {total_time:.3f} 秒")

    # 输出最终统计报告
    print("\n" + "=" * 50)
    print("MOEA/D 多次独立测试统计报告")
    print("=" * 50)
    final_stats = {}
    for key, values in stats.items():
        if not values:
            final_stats[key] = "无有效数据"
            continue
        mean_val = np.mean(values)
        std_val = np.std(values)
        final_stats[key] = f"{mean_val:.3f} ± {std_val:.3f}"

    print(f"测试次数: {len(stats['best_ce_list'])} 次（有效测试）")
    print(f"最优费效比: {final_stats['best_ce_list']}")
    print(f"平均费效比: {final_stats['avg_ce_list']}")
    print(f"最优任务时间: {final_stats['best_task_time']}")
    print(f"平均任务时间: {final_stats['avg_task_time']}")
    print(f"收敛代数: {final_stats['convergence_gen_list']}")
    print(f"平均求解时间: {final_stats['total_time_list']} 秒")
    print(f"去重后解数量: {final_stats['unique_solutions_num_list']}")

    # 输出全局最优解详情
    print("\n" + "=" * 60)
    print(f"MOEA/D 全局最优费效比解（最高值: {global_best_ce:.4f}）")
    print("=" * 60)
    if global_best_solution is None:
        print("未找到有效解")
        return

    best_obj, best_gen, test_idx, relative_time = global_best_metadata
    best_time = best_obj[1]

    print(f"测试来源: 第 {test_idx + 1} 次测试")
    print(f"生成代数: 第 {best_gen} 代")
    print(f"生成时间: {relative_time:.3f} 秒")
    print(f"费效比: {global_best_ce:.4f}，任务时间: {best_time:.2f}")
    print("\n详细分配方案:")

    solver = MOEA_D_Solver(targets, ammunitions, adaptability_matrix, 0.8)
    for j, target in enumerate(targets):
        target_total = 0
        ammo_details = []
        for i, ammo in enumerate(ammunitions):
            rounds = global_best_solution[i, j]
            if rounds > 0:
                target_total += rounds
                ammo_details.append(f"弹药{ammo.id}: {rounds}发（成本: {ammo.cost * rounds:.2f}）")

        damage = solver.calculate_actual_damage(global_best_solution, j)
        status = "✓ 达标" if damage >= 0.8 else "✗ 未达标"
        print(f"目标{target.id}:")
        print(f"  总弹药: {target_total}发，毁伤概率: {damage:.4f}（{status}）")
        if ammo_details:
            print(f"  分配详情: {', '.join(ammo_details)}")

    # 全局消耗统计
    total_cost = 0.0
    total_damage_value = 0.0
    for j, target in enumerate(targets):
        total_damage_value += target.value * solver.calculate_actual_damage(global_best_solution, j)
        for i, ammo in enumerate(ammunitions):
            total_cost += ammo.cost * global_best_solution[i, j]

    print("\n全局统计:")
    print(f"总弹药消耗: {np.sum(global_best_solution)}发")
    print(f"总成本: {total_cost:.2f}，总毁伤价值: {total_damage_value:.2f}")
    print(f"费效比验证: {total_damage_value / total_cost:.4f}")


if __name__ == "__main__":
    run_multiple_tests(test_times=15)