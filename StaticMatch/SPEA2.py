# SPEA2_Final_Correct.py
import numpy as np
import random
import time
from typing import List, Tuple

class Target:
    def __init__(self, target_id: int, value: float, components: List[Tuple[float, float]]):
        self.id = target_id
        self.value = value
        self.components = components
        original_importances = [comp[0] for comp in components]
        total = sum(original_importances)
        if total == 0:
            raise ValueError("部件权重和不能为0")
        self.normalized_importances = [w / total for w in original_importances]

    def calculate_damage_effect(self, ammo_damage_prob: List[float]) -> float:
        if len(ammo_damage_prob) != len(self.components):
            raise ValueError(f"毁伤概率长度{len(ammo_damage_prob)}与部件数{len(self.components)}不匹配")
        return sum(norm * prob for (_, _), norm, prob in 
                   zip(self.components, self.normalized_importances, ammo_damage_prob))

class Ammunition:
    def __init__(self, id: int, cost: float, stock: int, damage_profiles: dict):
        self.id = id
        self.cost = cost
        self.stock = stock
        self.damage_profiles = damage_profiles

class SPEA2_Solver:
    def __init__(self, targets: List[Target], ammunitions: List[Ammunition],
                 adaptability_matrix: np.ndarray, damage_threshold: float = 0.8):
        self.targets = targets
        self.ammunitions = ammunitions
        self.adaptability_matrix = adaptability_matrix
        self.damage_threshold = damage_threshold

        self.cr = 0.8               # 交叉概率
        self.mr = 0.02              # 变异概率
        self.pop_size = 30          # 种群规模
        self.archive_size = 50      # 外部存档（归档集）规模
        self.max_gen = 500          # 最大进化代数
        self.k = 3                  # 密度估计的近邻参数

    def calculate_damage_efficiency(self, ammo_idx: int, target_idx: int) -> float:
        t = self.targets[target_idx]
        a = self.ammunitions[ammo_idx]
        probs = a.damage_profiles.get(t.id, [0.1] * len(t.components))
        return self.adaptability_matrix[ammo_idx, target_idx] * t.calculate_damage_effect(probs)

    def calculate_actual_damage(self, chrom: np.ndarray, target_idx: int) -> float:
        survival = 1.0
        for i in range(len(self.ammunitions)):
            n = chrom[i, target_idx]
            if n > 0:
                e = self.calculate_damage_efficiency(i, target_idx)
                if e >= 1.0: return 1.0
                survival *= (1 - e) ** n
        return 1 - survival

    def evaluate(self, chrom: np.ndarray) -> Tuple[float, float]:
        value = cost = 0.0
        for j, tgt in enumerate(self.targets):
            d = self.calculate_actual_damage(chrom, j)
            value += tgt.value * d
            for i, ammo in enumerate(self.ammunitions):
                cost += ammo.cost * chrom[i, j]
        ce = value / (cost + 1e-8)
        time = np.sum(chrom) * 0.5
        return ce, time

    def initialize_population(self) -> List[np.ndarray]:
        pop = []
        for _ in range(self.pop_size):
            ind = np.zeros((len(self.ammunitions), len(self.targets)), dtype=int)
            for j in range(len(self.targets)):
                effs = [(i, self.calculate_damage_efficiency(i, j)) for i in range(len(self.ammunitions))]
                effs.sort(key=lambda x: x[1], reverse=True)
                cur_d = 0.0
                k = 0
                while cur_d < self.damage_threshold and k < len(effs):
                    i, e = effs[k]
                    if e <= 0: 
                        k += 1
                        continue
                    need = max(1, int(np.ceil(np.log(1-self.damage_threshold)/np.log(1-e))))
                    remain = self.ammunitions[i].stock - np.sum(ind[i])
                    alloc = min(need, remain)
                    ind[i, j] = alloc
                    cur_d = self.calculate_actual_damage(ind, j)
                    k += 1
            pop.append(ind)
        return pop

    def dominance(self, a: Tuple[float,float], b: Tuple[float,float]) -> int:
        if (a[0] >= b[0] and a[1] <= b[1]) and (a[0] > b[0] or a[1] < b[1]): return 1
        if (b[0] >= a[0] and b[1] <= a[1]) and (b[0] > a[0] or a[1] < b[1]): return -1
        return 0

    def compute_fitness(self, individuals):
        n = len(individuals)
        objs = [self.evaluate(ind) for ind in individuals]
        strength = np.zeros(n)
        raw = np.zeros(n)
        for i in range(n):
            for j in range(n):
                if i == j: continue
                if self.dominance(objs[i], objs[j]) == 1:
                    strength[i] += 1
        for i in range(n):
            for j in range(n):
                if i == j: continue
                if self.dominance(objs[j], objs[i]) == 1:
                    raw[i] += strength[j]
        dists = np.zeros((n,n))
        for i in range(n):
            for j in range(n):
                if i != j:
                    dists[i,j] = np.linalg.norm(np.array(objs[i]) - np.array(objs[j]))
        density = np.zeros(n)
        for i in range(n):
            d = np.sort(dists[i])
            kth = d[min(self.k, len(d)-1)]
            density[i] = 1.0 / (kth + 2.0)
        return raw + density, objs

    # def truncation(self, archive, objs):
    #     while len(archive) > self.archive_size:
    #         n = len(archive)
    #         min_d = np.inf
    #         rid = 0
    #         for i in range(n):
    #             ds = [np.linalg.norm(np.array(objs[i])-np.array(objs[j])) for j in range(n) if j!=i]
    #             if ds:
    #                 cd = min(ds)
    #                 if cd < min_d:
    #                     min_d = cd
    #                     rid = i
    #         archive.pop(rid)
    #         objs.pop(rid)
    #     return archive

    def truncation(self, archive, objs):
        while len(archive) > self.archive_size:
            # 每次只删一个最拥挤的（最常用最快）
            dists = []
            for i, obj in enumerate(objs):
                d = sorted([np.linalg.norm(np.array(obj) - np.array(o)) for o in objs if o is not obj])
                dists.append(d[0] if d else 1e9)
            rid = int(np.argmin(dists))
            archive.pop(rid)
            objs.pop(rid)
        return archive

    def repair(self, ind):
        ind = ind.copy()
        # 库存修复
        for i in range(len(self.ammunitions)):
            used = np.sum(ind[i])
            if used > self.ammunitions[i].stock:
                excess = used - self.ammunitions[i].stock
                order = np.argsort(-ind[i])
                for j in order:
                    if excess <= 0: break
                    cut = min(excess, ind[i,j])
                    ind[i,j] -= cut
                    excess -= cut
        # 毁伤修复
        for j in range(len(self.targets)):
            d = self.calculate_actual_damage(ind, j)
            cnt = 0
            while d < self.damage_threshold and cnt < 30:
                best_i = best_e = None
                for i in range(len(self.ammunitions)):
                    if np.sum(ind[i]) < self.ammunitions[i].stock:
                        e = self.calculate_damage_efficiency(i, j)
                        if best_e is None or e > best_e:
                            best_e, best_i = e, i
                if best_i is not None:
                    ind[best_i, j] += 1
                    d = self.calculate_actual_damage(ind, j)
                cnt += 1
        return ind

    def crossover(self, p1, p2):
        if random.random() > self.cr: return p1.copy(), p2.copy()
        c1, c2 = p1.copy(), p2.copy()
        pt = random.randint(1, len(self.targets)-1)
        c1[:, pt:], c2[:, pt:] = p2[:, pt:], p1[:, pt:]
        return c1, c2

    def mutate(self, ind):
        for i in range(ind.shape[0]):
            for j in range(ind.shape[1]):
                if random.random() < self.mr:
                    delta = random.choice([-1,1])
                    new = max(0, ind[i,j] + delta)
                    if np.sum(ind[i]) - ind[i,j] + new <= self.ammunitions[i].stock:
                        ind[i,j] = new
        return ind

    def tournament(self, pool):
        a = random.choice(pool)
        b = random.choice(pool)
        fa,_ = self.compute_fitness([a])
        fb,_ = self.compute_fitness([b])
        return a if fa[0] < fb[0] else b

    def solve(self):
        population = self.initialize_population()
        archive = []
        for gen in range(self.max_gen):
            combined = population + archive
            if not combined: continue
            fitness, objs = self.compute_fitness(combined)
            new_archive = []
            new_objs = []
            for i,f in enumerate(fitness):
                if f < 1.0:
                    new_archive.append(combined[i])
                    new_objs.append(objs[i])
            if len(new_archive) == 0:
                idx = np.argmin(fitness)
                new_archive = [combined[idx]]
                new_objs = [objs[idx]]
            elif len(new_archive) > self.archive_size:
                new_archive = self.truncation(new_archive, new_objs)
            archive = [x.copy() for x in new_archive]

            offspring = []
            while len(offspring) < self.pop_size:
                p1 = self.tournament(archive) if archive else random.choice(population)
                p2 = self.tournament(archive) if archive else random.choice(population)
                c1,c2 = self.crossover(p1,p2)
                c1 = self.mutate(c1); c2 = self.mutate(c2)
                c1 = self.repair(c1); c2 = self.repair(c2)
                offspring.extend([c1,c2])
            population = offspring[:self.pop_size]

        final_fit, final_objs = self.compute_fitness(archive)
        pareto = [(archive[i], final_objs[i]) for i,f in enumerate(final_fit) if f < 1.0]
        return pareto, gen+1


# ============================== 多轮测试 + 统计 + 全局最优 ==============================
def run_multiple_tests_spea2(test_times: int = 15):
    stats = {
        "best_ce_list": [], 
        "avg_ce_list": [], 
        "best_task_time"
        "": [],
        "avg_task_time": [],
        "convergence_gen_list": [],
        "total_time_list": [], 
        "unique_solutions_num_list": [], 
        "density_avg_list": []
    }

    global_best_ce = -np.inf
    global_best_solution = None
    global_best_metadata = None   # (obj, gen, test_idx, elapsed)


    # 测试参数(8*5个目标)
    # targets = [
    #     Target(1, 80.0, [(0.5, 1.0)]),# 人员集群
    #     Target(2, 120.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0)]),# 地下指挥所
    #     Target(3, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
    #                       (0.8, 1.0)]),# 陆基雷达站
    #     Target(4, 110.0, [(0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.2, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.2, 1.0), (0.8, 1.0), 
    #                       (0.5, 1.0)]),# 机场
    #     Target(5, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
    #                       (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
    #                       (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
    #                       (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
    # ]

    # ammunitions = [
    #     Ammunition(1, 13.0, 10, {
    #         1: [0.8], 
    #         2: [0.8, 0.8, 0.8, 0.6, 0.6,
    #             0.5, 0.8, 0.7, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.8, 0.1], 
    #         3: [0.5, 0.2, 0.6, 0.7, 0.8,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         4: [0.2, 0.2, 0.8, 0.7, 0.7,
    #             0.7, 0.7, 0.2, 0.2, 0.3,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.6], 
    #         5: [0.7, 0.7, 0.7, 0.8, 0.8,
    #             0.8, 0.8, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.8, 0.7, 0.7, 0.6, 0.6,
    #             0.7, 0.5, 0.7, 0.7, 0.7,
    #             0.5, 0.6, 0.5, 
    #             0.5, 0.7, 0.5, 0.5, 0.5, 
    #             0.5, 0.3, 0.7, 0.5, 0.4,
    #             0.4, 0.4, 0.5, 0.5, 0.5,
    #             0.5, 0.5, 0.5,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #     }),# 杀爆1(当量大)
    #     Ammunition(2, 10.0, 10, {
    #         1: [0.7], 
    #         2: [0.7, 0.7, 0.7, 0.5, 0.5,
    #             0.4, 0.7, 0.6, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.7, 0.1], 
    #         3: [0.4, 0.2, 0.5, 0.6, 0.7,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.2],
    #         4: [0.2, 0.2, 0.7, 0.6, 0.6,
    #             0.6, 0.6, 0.2, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.5], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.3, 0.4, 0.3, 0.4, 0.4, 
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.3, 0.4, 0.3, 0.4, 0.4,
    #             0.4, 0.4], 
    #     }),# 杀爆2(当量小)
    #     Ammunition(3, 20.0, 10, {
    #         1: [0.1], 
    #         2: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7, 
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.5, 0.7], 
    #         3: [0.7, 0.7, 0.3, 0.3, 0.5,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.7,
    #             0.7],
    #         4: [0.7, 0.7, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.7, 0.7, 0.7,
    #             0.7, 0.7, 0.7, 0.7, 0.6, 
    #             0.7], 
    #         5: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #     }),# 侵爆1(1.8m)
    #     Ammunition(4, 25.0, 10, {
    #         1: [0.1], 
    #         2: [0.65, 0.65, 0.65, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75, 
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.55, 0.75], 
    #         3: [0.75, 0.75, 0.35, 0.35, 0.55,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.75],
    #         4: [0.75, 0.75, 0.45, 0.45, 0.45,
    #             0.45, 0.45, 0.75, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.65, 
    #             0.75], 
    #         5: [0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1,                            
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #     }),# 侵爆2(6m)
    #     Ammunition(5, 40.0, 10, {
    #         1: [0.2], 
    #         2: [0.7, 0.7, 0.7, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8, 
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.6, 0.8], 
    #         3: [0.8, 0.8, 0.4, 0.4, 0.6,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.8,
    #             0.8],
    #         4: [0.8, 0.8, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.8, 0.8, 0.8,
    #             0.8, 0.8, 0.8, 0.8, 0.7, 
    #             0.8], 
    #         5: [0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15,                            
    #             0.15, 0.15, 0.15, 0.15, 0.15, 
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15, 0.15, 0.15, 0.15,
    #             0.15, 0.15], 
    #     }),# 侵爆3(61m)
    #     Ammunition(6, 27.0, 10, {
    #         1: [0.9], 
    #         2: [0.85, 0.85, 0.85, 0.65, 0.65,
    #             0.55, 0.85, 0.75, 0.2, 0.2,
    #             0.2, 0.2, 0.2, 0.2, 0.2, 
    #             0.2, 0.2, 0.2, 0.2, 0.2,
    #             0.85, 0.2], 
    #         3: [0.55, 0.25, 0.65, 0.75, 0.85,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25, 0.25, 0.25, 0.25, 0.25,
    #             0.25],
    #         4: [0.3, 0.3, 0.8, 0.75, 0.7,
    #             0.7, 0.75, 0.3, 0.3, 0.35,
    #             0.3, 0.3, 0.3, 0.3, 0.3, 
    #             0.6], 
    #         5: [0.75, 0.75, 0.75, 0.85, 0.85,
    #             0.85, 0.85, 0.65, 0.75, 0.75,
    #             0.75, 0.75, 0.75, 0.75, 0.75,
    #             0.85, 0.75, 0.75, 0.65, 0.65,
    #             0.75, 0.55, 0.75, 0.75, 0.75,
    #             0.55, 0.65, 0.55, 
    #             0.55, 0.75, 0.55, 0.55, 0.55, 
    #             0.55, 0.35, 0.75, 0.55, 0.45,
    #             0.45, 0.45, 0.55, 0.55, 0.55,
    #             0.55, 0.55, 0.55,                           
    #             0.45, 0.55, 0.45, 0.55, 0.55, 
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.45, 0.55, 0.45, 0.55, 0.55,
    #             0.55, 0.55], 
    #     }),# 子母1
    #     Ammunition(7, 20.0, 10, {
    #         1: [0.1], 
    #         2: [0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         3: [0.1, 0.1, 0.1, 0.3, 0.3,
    #             0.4, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         4: [0.1, 0.1, 0.4, 0.2, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #     }),# 聚能1(1.3m破甲)
    #     Ammunition(8, 18.0, 10, {
    #         1: [0.1], 
    #         2: [0.5, 0.5, 0.5, 0.5, 0.5,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1], 
    #         3: [0.1, 0.1, 0.1, 0.2, 0.2,
    #             0.3, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1],
    #         4: [0.1, 0.1, 0.3, 0.15, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1,
    #             0.1, 0.1, 0.1, 0.1, 0.1, 
    #             0.1], 
    #         5: [0.6, 0.6, 0.6, 0.7, 0.7,
    #             0.7, 0.7, 0.5, 0.6, 0.6,
    #             0.6, 0.6, 0.6, 0.6, 0.6,
    #             0.7, 0.6, 0.6, 0.5, 0.5,
    #             0.6, 0.4, 0.6, 0.6, 0.6,
    #             0.4, 0.5, 0.4, 
    #             0.4, 0.6, 0.4, 0.4, 0.4, 
    #             0.4, 0.2, 0.6, 0.4, 0.3,
    #             0.3, 0.3, 0.4, 0.4, 0.4,
    #             0.4, 0.4, 0.4,                           
    #             0.4, 0.5, 0.4, 0.5, 0.5, 
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.4, 0.5, 0.4, 0.5, 0.5,
    #             0.5, 0.5], 
    #     })# 聚能2(1.1m破甲)
    # ]

    # adaptability_matrix = np.array([
    #     [0.9, 0.25, 0.45, 0.25, 0.8],   # 杀爆1
    #     [0.8, 0.2, 0.4, 0.2, 0.7],      # 杀爆2
    #     [0.1, 0.7, 0.75, 0.75, 0.1],    # 侵爆1
    #     [0.1, 0.8, 0.8, 0.8, 0.1],      # 侵爆2
    #     [0.1, 0.9, 0.85, 0.85, 0.1],    # 侵爆3
    #     [0.9, 0.3, 0.5, 0.6, 0.9],      # 子母1
    #     [0.1, 0.2, 0.1, 0.1, 0.7],      # 聚能1
    #     [0.1, 0.15, 0.1, 0.1, 0.7],     # 聚能2
    # ])


    # 测试参数8*9个目标
    targets = [
        Target(1, 80.0, [(0.5, 1.0)]),# 人员集群
        Target(2, 120.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0)]),# 地下指挥所
        Target(3, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0)]),# 陆基雷达站
        Target(4, 110.0, [(0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.2, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.2, 1.0), (0.8, 1.0), 
                          (0.5, 1.0)]),# 机场
        Target(5, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
        Target(6, 80.0, [(0.5, 1.0)]),# 人员集群
        Target(7, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0)]),# 陆基雷达站
        Target(8, 100.0, [(0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), 
                          (0.8, 1.0)]),# 陆基雷达站
        Target(9, 105.0, [(0.2, 1.0), (0.2, 1.0), (0.2, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.5, 1.0), (0.5, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0),
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0), (0.8, 1.0),                           
                          (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), (0.8, 1.0), (0.5, 1.0), 
                          (0.5, 1.0), (0.2, 1.0), (0.8, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.2, 1.0), (0.2, 1.0), (0.5, 1.0), (0.5, 1.0), (0.5, 1.0),
                          (0.8, 1.0), (0.8, 1.0) ]),# 阵地(雷达车15个，电源车13个，导弹发射车18个，指挥控制车17个)
    ]

    ammunitions = [
        Ammunition(1, 13.0, 10, {
            1: [0.8], 
            2: [0.8, 0.8, 0.8, 0.6, 0.6,
                0.5, 0.8, 0.7, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.8, 0.1], 
            3: [0.5, 0.2, 0.6, 0.7, 0.8,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            4: [0.2, 0.2, 0.8, 0.7, 0.7,
                0.7, 0.7, 0.2, 0.2, 0.3,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.6], 
            5: [0.7, 0.7, 0.7, 0.8, 0.8,
                0.8, 0.8, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.8, 0.7, 0.7, 0.6, 0.6,
                0.7, 0.5, 0.7, 0.7, 0.7,
                0.5, 0.6, 0.5, 
                0.5, 0.7, 0.5, 0.5, 0.5, 
                0.5, 0.3, 0.7, 0.5, 0.4,
                0.4, 0.4, 0.5, 0.5, 0.5,
                0.5, 0.5, 0.5,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
            6: [0.8], 
            7: [0.5, 0.2, 0.6, 0.7, 0.8,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            8: [0.5, 0.2, 0.6, 0.7, 0.8,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            9: [0.7, 0.7, 0.7, 0.8, 0.8,
                0.8, 0.8, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.8, 0.7, 0.7, 0.6, 0.6,
                0.7, 0.5, 0.7, 0.7, 0.7,
                0.5, 0.6, 0.5, 
                0.5, 0.7, 0.5, 0.5, 0.5, 
                0.5, 0.3, 0.7, 0.5, 0.4,
                0.4, 0.4, 0.5, 0.5, 0.5,
                0.5, 0.5, 0.5,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
        }),# 杀爆1(当量大)
        Ammunition(2, 10.0, 10, {
            1: [0.7], 
            2: [0.7, 0.7, 0.7, 0.5, 0.5,
                0.4, 0.7, 0.6, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.7, 0.1], 
            3: [0.4, 0.2, 0.5, 0.6, 0.7,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            4: [0.2, 0.2, 0.7, 0.6, 0.6,
                0.6, 0.6, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.5], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.3, 0.4, 0.3, 0.4, 0.4, 
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.4, 0.4], 
            6: [0.7], 
            7: [0.4, 0.2, 0.5, 0.6, 0.7,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            8: [0.4, 0.2, 0.5, 0.6, 0.7,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.2],
            9: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.3, 0.4, 0.3, 0.4, 0.4, 
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.3, 0.4, 0.3, 0.4, 0.4,
                0.4, 0.4], 
        }),# 杀爆2(当量小)
        Ammunition(3, 20.0, 10, {
            1: [0.1], 
            2: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7, 
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.5, 0.7], 
            3: [0.7, 0.7, 0.3, 0.3, 0.5,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7],
            4: [0.7, 0.7, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.6, 
                0.7], 
            5: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            6: [0.1], 
            7: [0.7, 0.7, 0.3, 0.3, 0.5,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7],
            8: [0.7, 0.7, 0.3, 0.3, 0.5,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7, 0.7, 0.7, 0.7, 0.7,
                0.7],
            9: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
        }),# 侵爆1(1.8m)
        Ammunition(4, 25.0, 10, {
            1: [0.1], 
            2: [0.65, 0.65, 0.65, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75, 
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.55, 0.75], 
            3: [0.75, 0.75, 0.35, 0.35, 0.55,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75],
            4: [0.75, 0.75, 0.45, 0.45, 0.45,
                0.45, 0.45, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.65, 
                0.75], 
            5: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            6: [0.1], 
            7: [0.75, 0.75, 0.35, 0.35, 0.55,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75],
            8: [0.75, 0.75, 0.35, 0.35, 0.55,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.75],
            9: [0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1,                            
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1],    
        }),# 侵爆2(6m)
        Ammunition(5, 40.0, 10, {
            1: [0.2], 
            2: [0.7, 0.7, 0.7, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8, 
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.6, 0.8], 
            3: [0.8, 0.8, 0.4, 0.4, 0.6,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8],
            4: [0.8, 0.8, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.7, 
                0.8], 
            5: [0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15,                            
                0.15, 0.15, 0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15], 
            6: [0.2],
            7: [0.8, 0.8, 0.4, 0.4, 0.6,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8],
            8: [0.8, 0.8, 0.4, 0.4, 0.6,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8, 0.8, 0.8, 0.8, 0.8,
                0.8],
            9: [0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15,                            
                0.15, 0.15, 0.15, 0.15, 0.15, 
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15, 0.15, 0.15, 0.15,
                0.15, 0.15],
        }),# 侵爆3(61m)
        Ammunition(6, 27.0, 10, {
            1: [0.9], 
            2: [0.85, 0.85, 0.85, 0.65, 0.65,
                0.55, 0.85, 0.75, 0.2, 0.2,
                0.2, 0.2, 0.2, 0.2, 0.2, 
                0.2, 0.2, 0.2, 0.2, 0.2,
                0.85, 0.2], 
            3: [0.55, 0.25, 0.65, 0.75, 0.85,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25],
            4: [0.3, 0.3, 0.8, 0.75, 0.7,
                0.7, 0.75, 0.3, 0.3, 0.35,
                0.3, 0.3, 0.3, 0.3, 0.3, 
                0.6], 
            5: [0.75, 0.75, 0.75, 0.85, 0.85,
                0.85, 0.85, 0.65, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.85, 0.75, 0.75, 0.65, 0.65,
                0.75, 0.55, 0.75, 0.75, 0.75,
                0.55, 0.65, 0.55, 
                0.55, 0.75, 0.55, 0.55, 0.55, 
                0.55, 0.35, 0.75, 0.55, 0.45,
                0.45, 0.45, 0.55, 0.55, 0.55,
                0.55, 0.55, 0.55,                           
                0.45, 0.55, 0.45, 0.55, 0.55, 
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.55, 0.55], 
            6: [0.9],
            7: [0.55, 0.25, 0.65, 0.75, 0.85,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25],
            8: [0.55, 0.25, 0.65, 0.75, 0.85,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25, 0.25, 0.25, 0.25, 0.25,
                0.25],
            9: [0.75, 0.75, 0.75, 0.85, 0.85,
                0.85, 0.85, 0.65, 0.75, 0.75,
                0.75, 0.75, 0.75, 0.75, 0.75,
                0.85, 0.75, 0.75, 0.65, 0.65,
                0.75, 0.55, 0.75, 0.75, 0.75,
                0.55, 0.65, 0.55, 
                0.55, 0.75, 0.55, 0.55, 0.55, 
                0.55, 0.35, 0.75, 0.55, 0.45,
                0.45, 0.45, 0.55, 0.55, 0.55,
                0.55, 0.55, 0.55,                           
                0.45, 0.55, 0.45, 0.55, 0.55, 
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.45, 0.55, 0.45, 0.55, 0.55,
                0.55, 0.55],
        }),# 子母1
        Ammunition(7, 20.0, 10, {
            1: [0.1], 
            2: [0.6, 0.6, 0.6, 0.6, 0.6,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            3: [0.1, 0.1, 0.1, 0.3, 0.3,
                0.4, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            4: [0.1, 0.1, 0.4, 0.2, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
            6: [0.1],
            7: [0.1, 0.1, 0.1, 0.3, 0.3,
                0.4, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            8: [0.1, 0.1, 0.1, 0.3, 0.3,
                0.4, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            9: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5],
        }),# 聚能1(1.3m破甲)
        Ammunition(8, 18.0, 10, {
            1: [0.1], 
            2: [0.5, 0.5, 0.5, 0.5, 0.5,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1], 
            3: [0.1, 0.1, 0.1, 0.2, 0.2,
                0.3, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            4: [0.1, 0.1, 0.3, 0.15, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1, 
                0.1], 
            5: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5], 
            6: [0.1],
            7: [0.1, 0.1, 0.1, 0.2, 0.2,
                0.3, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            8: [0.1, 0.1, 0.1, 0.2, 0.2,
                0.3, 0.1, 0.1, 0.1, 0.1,
                0.1, 0.1, 0.1, 0.1, 0.1,
                0.1],
            9: [0.6, 0.6, 0.6, 0.7, 0.7,
                0.7, 0.7, 0.5, 0.6, 0.6,
                0.6, 0.6, 0.6, 0.6, 0.6,
                0.7, 0.6, 0.6, 0.5, 0.5,
                0.6, 0.4, 0.6, 0.6, 0.6,
                0.4, 0.5, 0.4, 
                0.4, 0.6, 0.4, 0.4, 0.4, 
                0.4, 0.2, 0.6, 0.4, 0.3,
                0.3, 0.3, 0.4, 0.4, 0.4,
                0.4, 0.4, 0.4,                           
                0.4, 0.5, 0.4, 0.5, 0.5, 
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.4, 0.5, 0.4, 0.5, 0.5,
                0.5, 0.5],
        })# 聚能2(1.1m破甲)
    ]

    adaptability_matrix = np.array([
        [0.9, 0.25, 0.45, 0.25, 0.8, 0.9, 0.45, 0.45, 0.8],   # 杀爆1
        [0.8, 0.2, 0.4, 0.2, 0.7, 0.8, 0.4, 0.4, 0.7],      # 杀爆2
        [0.1, 0.7, 0.75, 0.75, 0.1, 0.1, 0.75, 0.75, 0.1],    # 侵爆1
        [0.1, 0.8, 0.8, 0.8, 0.1, 0.1, 0.8, 0.8, 0.1],      # 侵爆2
        [0.1, 0.9, 0.85, 0.85, 0.1, 0.1, 0.85, 0.85, 0.1],    # 侵爆3
        [0.9, 0.3, 0.5, 0.6, 0.9, 0.9, 0.5, 0.5, 0.9],      # 子母1
        [0.1, 0.2, 0.1, 0.1, 0.7, 0.1, 0.1, 0.1, 0.7],      # 聚能1
        [0.1, 0.15, 0.1, 0.1, 0.7, 0.1, 0.1, 0.1, 0.7],     # 聚能2
    ])
    solver = SPEA2_Solver(targets, ammunitions, adaptability_matrix, 0.8)

    print(f"开始 {test_times} 次独立 SPEA2 测试（已优化速度）\n")

    for test_idx in range(test_times):
        print(f"\n=== 第 {test_idx+1}/{test_times} 次测试 ===")
        random.seed(test_idx + 1000)
        np.random.seed(test_idx + 1000)

        t0 = time.time()
        pareto, conv_gen = solver.solve()
        elapsed = time.time() - t0

        if not pareto:
            print("本次无解，跳过")
            continue

        ces = [obj[0] for _, obj in pareto]
        task_times = [obj[1] for _, obj in pareto]    # 注意这里是 obj[1]
        current_best_task_time = min(task_times)
        current_avg_task_time = np.mean(task_times)

        best_ce = max(ces)
        avg_ce = np.mean(ces)
        unique_num = len(pareto)

        # 计算平均密度（SPEA2用density而非crowding distance）
        final_fitness, _ = solver.compute_fitness([s for s, _ in pareto])  # 只算一次！
        # SPEA2 中 fitness = raw_fitness + density，raw_fitness < |P|+|A|，但我们只关心多样性，密度主导
        # 所以直接用 1/(fitness + epsilon) 作为多样性指标（学术论文里常见做法）
        density_avg = np.mean(1.0 / (final_fitness + 1e-8))
        if np.isnan(density_avg) or np.isinf(density_avg):
            density_avg = 0.0

        # 记录统计
        stats["best_ce_list"].append(best_ce)
        stats["avg_ce_list"].append(avg_ce)
        stats["best_task_time"].append(current_best_task_time)
        stats["avg_task_time"].append(current_avg_task_time)
        stats["convergence_gen_list"].append(conv_gen)
        stats["total_time_list"].append(elapsed)
        stats["unique_solutions_num_list"].append(unique_num)
        stats["density_avg_list"].append(density_avg)

        # 全局最优更新
        idx = np.argmax(ces)
        cur_sol, cur_obj = pareto[idx]
        if best_ce > global_best_ce:
            global_best_ce = best_ce
            global_best_solution = cur_sol.copy()
            global_best_metadata = (cur_obj, conv_gen, test_idx, elapsed)
            print(f"刷新全局最优！费效比 = {global_best_ce:.4f}")
        print(f"本次最优: {best_ce:.4f}  平均: {avg_ce:.4f}  解数量: {unique_num}  用时: {elapsed:.2f}s")

    # ====================== 统计报告（和你贴的完全一致）======================
    print("\n" + "="*60)
    print("SPEA2 多次独立测试统计报告")
    print("="*60)
    final_stats = {}
    for k, v in stats.items():
        if not v:
            final_stats[k] = "无有效数据"
            continue
        final_stats[k] = f"{np.mean(v):.4f} ± {np.std(v):.4f}"

    print(f"有效测试次数: {len(stats['best_ce_list'])}")
    print(f"最优费效比      : {final_stats['best_ce_list']}")
    print(f"平均费效比      : {final_stats['avg_ce_list']}")
    print(f"最短火力时间      : {final_stats['best_task_time']}")
    print(f"平均火力时间      : {final_stats['avg_task_time']}")
    print(f"收敛代数        : {final_stats['convergence_gen_list']}")
    print(f"平均求解时间    : {final_stats['total_time_list']} 秒")
    print(f"平均Pareto解数量: {final_stats['unique_solutions_num_list']}")
    print(f"平均密度        : {final_stats['density_avg_list']}")

    # ====================== 全局最优解详细输出 ======================
    if global_best_solution is None:
        print("\n未找到任何有效解")
        return

    print("\n" + "="*70)
    print(f"全局最优费效比解（最高值: {global_best_ce:.4f}）")
    print("="*70)
    best_obj, best_gen, test_idx, elapsed = global_best_metadata
    print(f"来源: 第 {test_idx+1} 次测试，第 {best_gen} 代，耗时 {elapsed:.2f}s")
    print(f"费效比: {global_best_ce:.4f}  任务时间: {best_obj[1]:.2f}")

    print("\n详细分配方案:")
    for j, tgt in enumerate(targets):
        details = []
        total_rounds = 0
        for i, ammo in enumerate(ammunitions):
            n = int(global_best_solution[i, j])
            if n > 0:
                total_rounds += n
                details.append(f"弹药{ammo.id}:{n}发(¥{ammo.cost*n:.1f})")
        dmg = solver.calculate_actual_damage(global_best_solution, j)
        status = "✓ 达标" if dmg >= 0.8 else "✗ 未达标"
        print(f"目标{tgt.id} (价值 {tgt.value}): 共 {total_rounds} 发, 毁伤 {dmg:.4f} {status}")
        if details:
            print(f"   → {', '.join(details)}")

    total_cost = sum(ammunitions[i].cost * global_best_solution[i].sum() for i in range(len(ammunitions)))
    total_value = sum(t.value * solver.calculate_actual_damage(global_best_solution, j) for j, t in enumerate(targets))
    print("\n全局统计:")
    print(f"总弹药消耗: {int(global_best_solution.sum())} 发")
    print(f"总成本: {total_cost:.2f}   总毁伤价值: {total_value:.2f}")
    print(f"费效比验证: {total_value/total_cost:.4f}")

if __name__ == "__main__":
    run_multiple_tests_spea2(test_times=15)